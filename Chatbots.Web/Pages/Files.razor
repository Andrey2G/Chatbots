@page "/chatbots/{ChatbotId:long}/files"
@inject ApiClient Api
@inject NavigationManager Nav

<h1>Files</h1>
<p class="text-muted">Manage documents attached to this chatbot.</p>

<div class="card">
    <div class="flex-between">
        <div class="actions">
            <button @onclick="@(() => Nav.NavigateTo($"/chatbots/{ChatbotId}/sessions"))">View Sessions</button>
            <button @onclick="@(() => Nav.NavigateTo($"/chatbots/{ChatbotId}/edit"))">Edit Chatbot</button>
        </div>
        <button @onclick="@(() => Nav.NavigateTo("/"))">Back</button>
    </div>
</div>

<div class="card">
    <h3>Upload files</h3>
    <InputFile OnChange="HandleUpload" multiple />
    @if (!string.IsNullOrEmpty(_uploadStatus))
    {
        <p>@_uploadStatus</p>
    }
</div>

<div class="card">
    <h3>Existing files</h3>
    @if (_files.Count == 0)
    {
        <p>No files uploaded yet.</p>
    }
    else
    {
        <table class="table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Size</th>
                    <th>Uploaded</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var file in _files)
                {
                    <tr>
                        <td>@file.FileName</td>
                        <td>@(file.FileSize / 1024) KB</td>
                        <td>@file.CreatedAt.LocalDateTime.ToString("g")</td>
                        <td>
                            <div class="actions">
                                <button @onclick="@(() => DeleteFileAsync(file.Id))">Delete</button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@code {
    [Parameter]
    public long ChatbotId { get; set; }

    private readonly List<ChatbotFileDto> _files = new();
    private string? _uploadStatus;

    protected override async Task OnInitializedAsync()
    {
        await LoadFilesAsync();
    }

    private async Task LoadFilesAsync()
    {
        _files.Clear();
        _files.AddRange(await Api.GetChatbotFilesAsync(ChatbotId));
    }

    private async Task HandleUpload(InputFileChangeEventArgs e)
    {
        if (e.FileCount == 0)
        {
            return;
        }

        await Api.UploadChatbotFilesAsync(ChatbotId, e.GetMultipleFiles());
        _uploadStatus = $"Uploaded {e.FileCount} files.";
        await LoadFilesAsync();
    }

    private async Task DeleteFileAsync(long fileId)
    {
        await Api.DeleteChatbotFileAsync(ChatbotId, fileId);
        await LoadFilesAsync();
    }
}
